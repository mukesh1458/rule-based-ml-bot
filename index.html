
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion-Aware Wellness Ally</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        :root {
            --background: #121212; --surface: #1E1E1E; --primary: #BB86FC;
            --secondary: #03DAC6; --on-background: #EAEAEA; --user-bubble: #33334D;
            --border-color: #2c2c2c;
        }
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 20px;
            background-color: var(--background); color: var(--on-background);
            display: flex; align-items: center; justify-content: center; min-height: 100vh;
        }

        /* --- Camera & Loading --- */
        #camera-view {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--background); z-index: 100; transition: opacity 0.5s ease-out;
        }
        #video-container { position: relative; width: 320px; height: 240px; border-radius: 10px; overflow: hidden; margin-bottom: 20px; background: #000; }
        #video { width: 100%; height: 100%; transform: scaleX(-1); }
        #status-message { font-size: 1.2rem; font-weight: 500; min-height: 50px; padding: 0 20px; }

        /* --- Main App Container --- */
        .container {
            width: 100%; max-width: 600px; background-color: var(--surface);
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; height: 90vh; position: relative;
        }
        #chat-container-wrapper { opacity: 0; transition: opacity 0.5s ease-in; }

        /* --- Header --- */
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .chat-header h1 { font-size: 1.2em; font-weight: 600; }
        .header-controls { display: flex; gap: 15px; }
        .control-button { background: none; border: none; color: var(--on-background); font-size: 1.2rem; cursor: pointer; }
        
        /* --- Chat & Messages --- */
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; display: flex; align-items: center; gap: 8px; animation: messageAppear 0.5s forwards; }
        .assistant-message { justify-content: flex-start; }
        .user-message { justify-content: flex-end; flex-direction: row-reverse; }
        .message-content { padding: 12px 20px; border-radius: 18px; max-width: 80%; }
        .user-message .message-content { background-color: var(--user-bubble); }
        .assistant-message .message-content { background-color: #272727; }
        .save-btn { color: #888; cursor: pointer; transition: color 0.2s; }
        .save-btn:hover, .save-btn.saved { color: var(--primary); }

        /* --- Input Area --- */
        .input-container { display: flex; padding: 15px; border-top: 1px solid var(--border-color); gap: 10px; }
        #user-input { flex-grow: 1; padding: 12px 20px; border-radius: 30px; font-size: 1em; background-color: #2c2c2c; color: var(--on-background); border: 1px solid var(--border-color); }
        #user-input:focus { outline: none; border-color: var(--primary); }
        .send-button, #mic-button { width: 50px; height: 50px; border-radius: 50%; border: none; background: #3700B3; color: white; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        #mic-button.active i { border-radius: 50%; animation: pulse 1.5s infinite; }
        
        /* --- Pop-up Panels (Music & Journal) --- */
        .panel {
            position: absolute; top: 65px; right: 20px; width: 280px;
            background-color: #2c2c2c; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            padding: 15px; z-index: 200; opacity: 0; transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none;
        }
        .panel.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #journal-panel .journal-entry {
            background: #3a3a3a; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9em;
        }
        #journal-panel .journal-entry small { color: #aaa; display: block; margin-bottom: 4px; }
        .download-btn { width: 100%; padding: 10px; background: var(--primary); color: #121212; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* --- Animations --- */
        @keyframes messageAppear { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(187, 134, 252, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 10px 20px rgba(187, 134, 252, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(187, 134, 252, 0); }
        }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #999; border-radius: 50%; display: inline-block;
            animation: typing 1s infinite ease-in-out;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.85); } 50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="camera-view">
        <div id="video-container"><video id="video" autoplay muted playsinline></video></div>
        <div id="status-message">Requesting camera access...</div>
    </div>
    
    <div id="chat-container-wrapper" class="container">
        <header class="chat-header">
            <h1>Mental Wellness Ally</h1>
            <div class="header-controls">
                <button id="journal-toggle" class="control-button"><i class="fa-solid fa-book-medical"></i></button>
                <button id="music-toggle" class="control-button"><i class="fa-solid fa-music"></i></button>
                <button id="speaker-toggle" class="control-button"><i class="fa-solid fa-volume-high"></i></button>
            </div>
        </header>
        <div class="chat-container" id="chat-container"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Say something...">
            <button id="mic-button" class="control-button"><i class="fa-solid fa-microphone"></i></button>
            <button id="send-button" class="send-button"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
        
        <!-- Pop-up Panels -->
        <div id="music-player-container" class="panel">
            <div id="playlist"></div>
            <audio id="audio-player" controls loop></audio>
        </div>
        <div id="journal-panel" class="panel">
            <h4>Session Journal</h4>
            <div id="journal-entries" style="max-height: 200px; overflow-y: auto;"></div>
            <button id="download-journal" class="download-btn">Download .txt</button>
        </div>
    </div>

<script>
    // --- App State & Elements ---
    const elements = {
        video: document.getElementById('video'), statusMessage: document.getElementById('status-message'),
        cameraView: document.getElementById('camera-view'), chatWrapper: document.getElementById('chat-container-wrapper'),
        chatContainer: document.getElementById('chat-container'), micButton: document.getElementById('mic-button'),
        speakerToggle: document.getElementById('speaker-toggle'), musicToggle: document.getElementById('music-toggle'),
        musicPlayerContainer: document.getElementById('music-player-container'), playlistDiv: document.getElementById('playlist'),
        audioPlayer: document.getElementById('audio-player'), userInput: document.getElementById('user-input'),
        sendButton: document.getElementById('send-button'), journalToggle: document.getElementById('journal-toggle'),
        journalPanel: document.getElementById('journal-panel'), journalEntriesDiv: document.getElementById('journal-entries'),
        downloadJournalBtn: document.getElementById('download-journal'),
    };
    
    const state = {
        speechEnabled: true, detectionInterval: null, fallbackTimeout: null,
        isListening: false, lastNegativeTopic: null, journalEntries: []
    };

    // --- Initial Setup ---
    window.addEventListener('load', setupCamera);
    
    async function setupCamera() {
        populatePlaylist();
        setupEventListeners();
        elements.statusMessage.textContent = 'Loading models...';
        try {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('/models'), faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
                faceapi.nets.faceExpressionNet.loadFromUri('/models'),
            ]);
            startVideoStream();
        } catch (error) {
            elements.statusMessage.innerHTML = "Couldn't load face models. Starting chat without video.";
            setTimeout(() => startChat("default"), 3000);
        }
    }
    
    function setupEventListeners() {
        elements.speakerToggle.addEventListener('click', toggleSpeaker);
        elements.musicToggle.addEventListener('click', () => togglePanel(elements.musicPlayerContainer));
        elements.journalToggle.addEventListener('click', () => {
            renderJournal();
            togglePanel(elements.journalPanel);
        });
        elements.micButton.addEventListener('click', toggleMic);
        elements.sendButton.addEventListener('click', handleSend);
        elements.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        elements.downloadJournalBtn.addEventListener('click', downloadJournal);
    }

    // --- Face Detection & Chat Start ---
    function startVideoStream() {
        elements.statusMessage.textContent = 'Please allow camera access.';
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                elements.video.srcObject = stream;
                elements.video.addEventListener('play', detectEmotion);
            })
            .catch(err => {
                elements.statusMessage.textContent = "Camera access denied. Starting chat normally.";
                setTimeout(() => startChat("default"), 2000);
            });
    }

    function detectEmotion() {
        elements.statusMessage.textContent = 'Looking for a face...';
        state.fallbackTimeout = setTimeout(() => {
            clearInterval(state.detectionInterval);
            if (elements.video.srcObject) elements.video.srcObject.getTracks().forEach(track => track.stop());
            elements.statusMessage.textContent = "Could not detect a face. Starting chat normally.";
            setTimeout(() => startChat("default"), 1500);
        }, 15000);

        state.detectionInterval = setInterval(async () => {
            const detection = await faceapi.detectSingleFace(elements.video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            if (detection) {
                clearTimeout(state.fallbackTimeout);
                const primaryEmotion = Object.keys(detection.expressions).reduce((a, b) => detection.expressions[a] > detection.expressions[b] ? a : b);
                if (detection.expressions[primaryEmotion] > 0.65) {
                    clearInterval(state.detectionInterval);
                    if (elements.video.srcObject) elements.video.srcObject.getTracks().forEach(track => track.stop());
                    startChat(primaryEmotion);
                }
            }
        }, 500);
    }
    
    function startChat(initialEmotion) {
        clearTimeout(state.fallbackTimeout);
        clearInterval(state.detectionInterval);
        elements.cameraView.style.opacity = '0';
        setTimeout(() => { elements.cameraView.style.display = 'none'; elements.chatWrapper.style.opacity = '1'; }, 500);
        
        const emotionInfo = emotionMapping[initialEmotion] || emotionMapping.default;
        let initialMessage = emotionInfo.message;
        if (initialEmotion !== 'default') {
             initialMessage = `I detected that you might be feeling ${initialEmotion}. ${initialMessage}`;
        }
        if (emotionInfo.isNegative) state.lastNegativeTopic = initialEmotion;
        
        addMessageToChat(initialMessage, false);
        if (emotionInfo.isNegative) {
            setTimeout(() => addMessageToChat("Simple exercises can help ground us. Would you be open to trying some?", false, createExerciseButton), 1500);
        }
    }

    // --- Message & Response Logic ---
    function handleSend() {
        const text = elements.userInput.value.trim();
        if (text) {
            _addMessageToUI(text, true);
            elements.userInput.value = '';
            showTypingIndicator();
            setTimeout(() => getBotResponse(text), 1200);
        }
    }

    function getBotResponse(text) {
        hideTypingIndicator();
        let responseCategory = 'default';
        let isNegative = false;
        const lowerText = text.toLowerCase();
        
        const keywords = { sad: ["sad", "down", "depressed"], anxious: ["stress", "anxious", "overwhelmed"], angry: ["angry", "mad", "frustrated"], happy: ["happy", "great", "good"] };
        
        let foundKeyword = false;
        for (const [key, value] of Object.entries(keywords)) {
            if (value.some(w => lowerText.includes(w))) {
                responseCategory = key;
                if (key !== 'happy') {
                    isNegative = true;
                    state.lastNegativeTopic = key;
                }
                foundKeyword = true;
                break;
            }
        }
        
        if (!foundKeyword && state.lastNegativeTopic) {
            responseCategory = 'contextual';
        }

        const responseList = responses[responseCategory];
        const response = responseList[Math.floor(Math.random() * responseList.length)].replace('{topic}', state.lastNegativeTopic);
        
        // Prevent asking the same contextual question twice.
        if (responseCategory === 'contextual') state.lastNegativeTopic = null;
        
        addMessageToChat(response, false, () => {
             if (isNegative) createExerciseButton();
        });
    }

    // --- UI Helpers ---
    function _addMessageToUI(content, isUser) {
        const messageId = `msg-${Date.now()}`;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = content;

        const saveBtn = document.createElement('i');
        saveBtn.className = 'fa-solid fa-bookmark save-btn';
        saveBtn.title = 'Save to journal';
        saveBtn.onclick = () => saveToJournal(content, isUser ? 'You' : 'Ally', saveBtn);

        messageDiv.appendChild(messageContent);
        messageDiv.appendChild(saveBtn);
        
        elements.chatContainer.appendChild(messageDiv);
        elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
    }
    
    function showTypingIndicator() { /* Creates and shows typing indicator */
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant-message typing-indicator';
        typingDiv.innerHTML = `<div class="message-content"><span></span><span></span><span></span></div>`;
        elements.chatContainer.appendChild(typingDiv);
        elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
    }

    function hideTypingIndicator() { /* Removes typing indicator */
        const indicator = elements.chatContainer.querySelector('.typing-indicator');
        if (indicator) indicator.remove();
    }
    
    function addMessageToChat(content, isUser, callback) { /* Public function to add message and speak it */
        _addMessageToUI(content, isUser);
        if (!isUser) speak(content.replace(/<[^>]*>/g, ""), callback);
    }
    
    function createExerciseButton() {
        const buttonDiv = document.createElement('div');
        buttonDiv.style.marginTop = '10px';
        buttonDiv.innerHTML = `<button style="padding: 10px 15px; background-color: var(--primary); border: none; border-radius: 5px; color: #121212; font-weight: bold; cursor: pointer;">Yes, let's try</button>`;
        const lastMessageContent = elements.chatContainer.querySelector('.message:last-child .message-content');
        if (lastMessageContent) lastMessageContent.appendChild(buttonDiv);
        buttonDiv.querySelector('button').addEventListener('click', (e) => {
            e.target.parentElement.innerHTML = '<p>Great! Let\'s begin.</p>'; provideExercises();
        });
    }
    
    function provideExercises() { /* Reads out exercises sequentially */
        let currentIndex = 0;
        function speakNextExercise() {
            if (currentIndex < wellnessExercises.length) {
                _addMessageToUI(`Exercise ${currentIndex + 1}: ${wellnessExercises[currentIndex]}`, false);
                speak(wellnessExercises[currentIndex], () => { currentIndex++; setTimeout(speakNextExercise, 700); });
            } else {
                _addMessageToUI("The exercises are complete. Let's check in again now.", false);
                speak("The exercises are complete. Let's check in again now.", reEvaluateEmotion);
            }
        }
        speakNextExercise();
    }

    function reEvaluateEmotion() { /* Re-activates camera to detect emotion */
        elements.cameraView.style.display = 'flex';
        setTimeout(() => elements.cameraView.style.opacity = '1', 50);
        elements.statusMessage.textContent = 'Checking your expression again...';
        startVideoStream();
    }
    
    // --- Journaling ---
    function saveToJournal(content, author, btnElement) {
        state.journalEntries.push({ text: content, author: author, timestamp: new Date() });
        btnElement.classList.add('saved');
        btnElement.title = 'Saved!';
    }
    
    function renderJournal() {
        elements.journalEntriesDiv.innerHTML = '';
        if (state.journalEntries.length === 0) {
            elements.journalEntriesDiv.innerHTML = '<p>No entries saved yet. Click the bookmark icon next to a message to save it.</p>';
            return;
        }
        state.journalEntries.forEach(entry => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'journal-entry';
            const time = entry.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            entryDiv.innerHTML = `<small>${entry.author} at ${time}</small><p>${entry.text}</p>`;
            elements.journalEntriesDiv.appendChild(entryDiv);
        });
    }

    function downloadJournal() {
        if (state.journalEntries.length === 0) { alert('Your journal is empty!'); return; }
        const formattedDate = new Date().toISOString().slice(0, 10);
        let fileContent = `Wellness Journal Session - ${new Date().toLocaleString()}\n\n`;
        state.journalEntries.forEach(entry => {
            const time = entry.timestamp.toLocaleTimeString();
            fileContent += `[${time}] ${entry.author}:\n${entry.text}\n\n`;
        });
        
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Wellness-Journal-${formattedDate}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- Speech Synthesis & Recognition ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; recognition.lang = 'en-US';
        recognition.onstart = () => { state.isListening = true; elements.micButton.classList.add('active'); elements.userInput.setAttribute('placeholder', 'Listening...'); };
        recognition.onresult = (e) => { elements.userInput.value = e.results[0][0].transcript; handleSend(); };
        recognition.onend = () => { state.isListening = false; elements.micButton.classList.remove('active'); elements.userInput.setAttribute('placeholder', 'Say something...'); };
        recognition.onerror = (e) => { console.error('Speech recognition error:', e.error); state.isListening = false; elements.micButton.classList.remove('active'); };
    } else { elements.micButton.style.display = 'none'; }
    function toggleMic() { if (recognition) state.isListening ? recognition.stop() : recognition.start(); }
    
    function toggleSpeaker() { /* Toggles text-to-speech on/off */
        state.speechEnabled = !state.speechEnabled;
        elements.speakerToggle.innerHTML = state.speechEnabled ? '<i class="fa-solid fa-volume-high"></i>' : '<i class="fa-solid fa-volume-xmark"></i>';
        if (!state.speechEnabled) window.speechSynthesis.cancel();
    }
    
    function togglePanel(panel) { /* Opens/closes a generic panel */
        panel.classList.toggle('visible');
    }

    function speak(text, callback) {
        if (!state.speechEnabled || !text) { if (callback) callback(); return; }
        const audio = elements.audioPlayer;
        let originalVolume = audio.volume;
        if (!audio.paused) audio.volume *= 0.3; // Audio ducking
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.onend = () => { if (!audio.paused) audio.volume = originalVolume; if (callback) callback(); };
        utterThis.onerror = (e) => { if (!audio.paused) audio.volume = originalVolume; if (callback) callback(); };
        window.speechSynthesis.speak(utterThis);
    }
    
    // --- Music Player ---
    const playlistData = [{ title: "Lofi Chill", src: "https://bensound-for-backend.s3.amazonaws.com/sound/lofi-chill.mp3" }, { title: "Relaxing", src: "https://bensound-for-backend.s3.amazonaws.com/sound/relaxing.mp3" }, { title: "Tomorrow", src: "https://bensound-for-backend.s3.amazonaws.com/sound/tomorrow.mp3" }];
    function populatePlaylist() {
        playlistData.forEach((song, index) => {
            const item = document.createElement('div');
            item.className = 'playlist-item'; item.textContent = song.title; item.dataset.index = index;
            item.addEventListener('click', () => playSong(index));
            elements.playlistDiv.appendChild(item);
        });
    }
    function playSong(index) {
        elements.audioPlayer.src = playlistData[index].src;
        elements.audioPlayer.play();
        document.querySelectorAll('#playlist .playlist-item').forEach(item => item.classList.toggle('active', item.dataset.index == index));
    }
    
    // --- Data (Bot Responses & Mappings) ---
    const emotionMapping = {
        sad: { message: "It looks like you're feeling down. Your feelings are valid, and I'm here for you.", isNegative: true },
        happy: { message: "What a wonderful smile! It's great to see you looking so happy.", isNegative: false },
        neutral: { message: "Hello there. I'm here to listen if anything is on your mind.", isNegative: false },
        angry: { message: "I can sense some strong emotions. It's okay to feel angry. I'm here to listen without judgment.", isNegative: true },
        fearful: { message: "I notice a hint of anxiety. Remember to be kind to yourself. We can take it one step at a time.", isNegative: true },
        default: { message: "Hi! I'm your wellness ally. How are you feeling right now?", isNegative: false }
    };
    const wellnessExercises = [ "First, take a slow, deep breath in for 4 counts... hold for 4... and then exhale slowly for 6.", "Now, gently roll your shoulders up towards your ears... and then let them drop, releasing any tension.", "Place a hand on your heart and remind yourself: 'This is a difficult moment. It is okay to feel this way.'", "Finally, imagine a place where you feel completely at peace. Spend a few seconds just picturing it in your mind." ];
    const responses = {
        sad: [ "It's completely okay to feel sad. Talking about it can lighten the load. I'm here for you.", "I'm sorry you're feeling this way. Remember to be gentle with yourself.", "Hearing that you're feeling down makes me want to offer my full support." ],
        anxious: [ "That sounds incredibly challenging. Remember to breathe. We can work through this together.", "When we're anxious, our bodies are in high alert. Let's take it one step at a time.", "Anxiety can be overwhelming, but this feeling is temporary. I'm here to help." ],
        angry: [ "Anger is a powerful emotion, and a sign that something needs attention.", "It's okay to feel angry. Let's explore what's behind this feeling if you're comfortable.", "I hear your frustration. Sometimes just expressing it is the first step to feeling better." ],
        happy: [ "That's so wonderful to hear! What's been the highlight of your day?", "I love hearing that! It's important to celebrate these positive moments.", "That's fantastic! Thanks for sharing that positivity with me." ],
        contextual: [ "Just checking in, how are you feeling about what we discussed earlier?", "Before we move on, I wanted to circle back. Are you still feeling {topic}?", "I'm still thinking about what you said earlier. How are you holding up?" ],
        default: [ "Thanks for sharing. Could you tell me more?", "I'm listening. Tell me more about that.", "That's interesting. Please elaborate." ]
    };
</script>
</body>
</html>

